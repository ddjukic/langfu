generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id              String           @id @default(cuid())
  email           String           @unique
  password        String
  name            String?
  currentLanguage Language         @default(GERMAN)
  dailyGoal       Int              @default(20)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  
  progress        Progress[]
  wordHistory     WordHistory[]
  userSentences   UserSentence[]
  sessions        Session[]
  webExtractions  WebExtraction[]
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([token])
  @@index([userId])
}

model Progress {
  id             String   @id @default(cuid())
  userId         String
  language       Language
  wordsLearned   Int      @default(0)
  currentLevel   String   @default("A1")
  currentStreak  Int      @default(0)
  longestStreak  Int      @default(0)
  lastPractice   DateTime?
  totalScore     Int      @default(0)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([userId, language])
  @@index([userId])
}

model Word {
  id              String          @id @default(cuid())
  language        Language
  level           String          // A1, A2, B1, B2, C1, C2
  topic           String
  l2              String          // Target language word
  l1              String          // Native language translation
  pos             String?         // Part of speech
  gender          String?         // Gender (for German nouns)
  difficulty      Int             @default(1)
  frequency       Int             @default(0)
  createdAt       DateTime        @default(now())
  
  examples        Example[]
  wordHistory     WordHistory[]
  userSentences   UserSentence[]
  
  @@index([language, level, topic])
  @@index([l2])
}

model Example {
  id         String   @id @default(cuid())
  wordId     String
  sentence   String
  translation String?
  createdAt  DateTime @default(now())
  
  word       Word     @relation(fields: [wordId], references: [id], onDelete: Cascade)
  
  @@index([wordId])
}

model WordHistory {
  id            String    @id @default(cuid())
  userId        String
  wordId        String
  firstSeen     DateTime  @default(now())
  reviewCount   Int       @default(0)
  correctCount  Int       @default(0)
  lastReview    DateTime?
  nextReview    DateTime?
  masteryLevel  Int       @default(0) // 0-5 scale
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  word          Word      @relation(fields: [wordId], references: [id], onDelete: Cascade)
  
  @@unique([userId, wordId])
  @@index([userId])
  @@index([wordId])
  @@index([nextReview])
}

model UserSentence {
  id         String   @id @default(cuid())
  userId     String
  wordId     String
  sentence   String
  isCorrect  Boolean  @default(false)
  feedback   String?
  createdAt  DateTime @default(now())
  
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  word       Word     @relation(fields: [wordId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([wordId])
}

model VocabularySet {
  id          String   @id @default(cuid())
  name        String
  description String?
  language    Language
  isPublic    Boolean  @default(false)
  data        Json     // Stores the vocabulary in JSON format
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([language])
}

model WebExtraction {
  id             String          @id @default(cuid())
  userId         String
  url            String
  title          String?
  content        String          // Original HTML content
  language       Language
  wordCount      Int             @default(0)
  extractedAt    DateTime        @default(now())
  customTopic    String?
  level          String?         // Estimated CEFR level
  
  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  extractedWords ExtractedWord[]
  
  @@index([userId])
  @@index([language])
}

model ExtractedWord {
  id            String         @id @default(cuid())
  extractionId  String
  l2            String         // Foreign word
  l1            String         // English translation
  pos           String?        // Part of speech
  gender        String?        // Gender (for German)
  frequency     Int            @default(1) // Frequency in the source
  context       String?        // Example sentence from source
  difficulty    Int            @default(1)
  level         String?        // CEFR level
  
  extraction    WebExtraction  @relation(fields: [extractionId], references: [id], onDelete: Cascade)
  
  @@index([extractionId])
  @@index([l2])
}

enum Language {
  GERMAN
  SPANISH
}